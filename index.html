<!DOCTYPE html>
<html lang="zh-Hant" data-theme="business">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NBA æˆ°æƒ…å®¤ (DaisyUI + DataTablesç‰ˆ)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>

    <style>
        /* åœ–è¡¨å®¹å™¨é«˜åº¦ */
        .chart-wrapper {
            position: relative;
            height: 60vh;
            min-height: 400px;
            width: 100%;
        }
        .color-dot { display:inline-block; width:8px; height:8px; border-radius:50%; margin-right:8px; }

        /* --- DataTables æ·±è‰²æ¨¡å¼é©é… --- */
        /* è®“ DataTables çš„æ–‡å­—é¡è‰²é©æ‡‰ DaisyUI ä¸»é¡Œ */
        .dataTables_wrapper .dataTables_length, 
        .dataTables_wrapper .dataTables_filter, 
        .dataTables_wrapper .dataTables_info, 
        .dataTables_wrapper .dataTables_processing, 
        .dataTables_wrapper .dataTables_paginate {
            color: hsl(var(--bc) / 0.6) !important;
            margin-bottom: 10px;
        }
        
        /* æœå°‹æ¡†èˆ‡ä¸‹æ‹‰é¸å–®æ¨£å¼ */
        .dataTables_wrapper input, .dataTables_wrapper select {
            background-color: hsl(var(--b1));
            border: 1px solid hsl(var(--bc) / 0.2);
            border-radius: 0.5rem;
            padding: 4px 8px;
            color: hsl(var(--bc));
        }

        /* è¡¨æ ¼æ¨™é ­æ¨£å¼ */
        table.dataTable thead th, table.dataTable thead td {
            border-bottom: 1px solid hsl(var(--bc) / 0.2) !important;
            color: hsl(var(--bc) / 0.8);
        }
        
        /* è¡¨æ ¼å…§å®¹åˆ—æ¨£å¼ */
        table.dataTable tbody tr {
            background-color: hsl(var(--b2)) !important; /* å°æ‡‰ DaisyUI base-200 */
            color: hsl(var(--bc));
        }
        table.dataTable tbody tr:hover {
            background-color: hsl(var(--b3)) !important; /* å°æ‡‰ DaisyUI hover */
        }
        table.dataTable.no-footer {
            border-bottom: 1px solid hsl(var(--bc) / 0.2) !important;
        }

        /* åˆ†é æŒ‰éˆ•æ¨£å¼ */
        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            background: hsl(var(--p)) !important; /* Primary color */
            color: hsl(var(--pc)) !important;
            border: none !important;
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
            background: hsl(var(--pf)) !important;
            border: none !important;
            color: white !important;
        }
    </style>
</head>
<body class="p-4 lg:p-8 min-h-screen">

<div class="container mx-auto max-w-7xl">
    
    <header class="navbar bg-base-200 rounded-box shadow-lg mb-6 flex flex-col md:flex-row justify-between items-center p-4">
        <div class="flex flex-col md:flex-row items-center gap-2">
            <h1 class="text-2xl font-bold tracking-wider">NBA ANALYTICS</h1>
            <span class="badge badge-primary font-bold">V25.0</span>
            <span class="badge badge-ghost text-xs">DataTablesç‰ˆ</span>
        </div>
        <div class="text-right mt-2 md:mt-0">
            <div class="flex items-center gap-2 justify-end">
                <span id="status" class="badge badge-success badge-xs gap-1">Live</span>
            </div>
            <div id="last-update" class="text-xs text-base-content/50 mt-1">æ•¸æ“šçµ±è¨ˆæˆªè‡³: <span class="text-accent font-bold">è®€å–ä¸­...</span></div>
        </div>
    </header>

    <div id="loader" class="flex flex-col justify-center items-center h-64 gap-4">
        <span class="loading loading-spinner loading-lg text-primary"></span>
        <h2 class="text-xl font-bold animate-pulse">æ­£åœ¨é€£ç·šè³‡æ–™åº«...</h2>
    </div>

    <div id="main-content" class="hidden animate-fade-in-up">
        
        <div class="bg-base-200 p-4 rounded-xl shadow-md mb-6 border border-base-300">
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                
                <div class="form-control w-full">
                    <label class="label"><span class="label-text font-bold">ğŸ“… è³½å­£</span></label>
                    <select id="seasonFilter" class="select select-bordered select-sm w-full">
                        <option value="ALL">è¼‰å…¥ä¸­...</option>
                    </select>
                </div>

                <div class="form-control w-full">
                    <label class="label"><span class="label-text font-bold">ğŸ“ˆ åœ–è¡¨æ¨¡å¼</span></label>
                    <select id="chartMode" class="select select-bordered select-sm w-full">
                        <option value="efficiency">ğŸ€ æ”»å®ˆæ•ˆç‡</option>
                        <option value="homeAway">ğŸ  ä¸»å®¢æˆ°ç¸¾</option>
                    </select>
                </div>

                <div class="form-control w-full">
                    <label class="label"><span class="label-text font-bold">ğŸŒ åˆ†å€</span></label>
                    <select id="confFilter" class="select select-bordered select-sm w-full">
                        <option value="ALL">å…¨éƒ¨ (All)</option>
                        <option value="East">æ±å€ (Eastern)</option>
                        <option value="West">è¥¿å€ (Western)</option>
                    </select>
                </div>

                <div class="form-control w-full">
                    <label class="label"><span class="label-text font-bold">ğŸš© åˆ†çµ„</span></label>
                    <select id="divFilter" class="select select-bordered select-sm w-full">
                        <option value="ALL">å…¨éƒ¨ (All)</option>
                        <optgroup label="æ±å€ (East)">
                            <option value="Atlantic">å¤§è¥¿æ´‹çµ„</option>
                            <option value="Central">ä¸­å¤®çµ„</option>
                            <option value="Southeast">æ±å—çµ„</option>
                        </optgroup>
                        <optgroup label="è¥¿å€ (West)">
                            <option value="Northwest">è¥¿åŒ—çµ„</option>
                            <option value="Pacific">å¤ªå¹³æ´‹çµ„</option>
                            <option value="Southwest">è¥¿å—çµ„</option>
                        </optgroup>
                    </select>
                </div>

                <div class="form-control w-full">
                    <label class="label"><span class="label-text font-bold">ğŸ“Š åœ–è¡¨æ’åº</span></label>
                    <select id="metricFilter" class="select select-bordered select-sm w-full">
                        <option value="winRate">ç¸½å‹ç‡</option>
                        <option value="homeWinRate">ä¸»å ´å‹ç‡</option>
                        <option value="awayWinRate">å®¢å ´å‹ç‡</option>
                        <option value="netRtg">æ·¨æ•ˆç‡å€¼</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <div class="card bg-base-200 shadow-xl col-span-1 lg:col-span-2 border border-base-300">
                <div class="card-body p-4">
                    <h2 class="card-title text-sm uppercase tracking-widest text-base-content/70" id="chartTitle">Efficiency Landscape</h2>
                    <p id="chartDesc" class="text-xs text-base-content/50 -mt-2 mb-2">Xè»¸: é€²æ”»æ•ˆç‡ | Yè»¸: é˜²å®ˆæ•ˆç‡</p>
                    <div class="chart-wrapper">
                        <canvas id="scatterChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="card bg-base-200 shadow-xl h-full border border-base-300">
                <div class="card-body p-4">
                    <h3 class="font-bold text-base-content/70 uppercase tracking-widest mb-4">Team Rankings</h3>
                    
                    <div class="overflow-x-auto">
                        <table id="statsTable" class="row-border hover" style="width:100%">
                            <thead>
                                <tr>
                                    <th>RK</th>
                                    <th>TEAM</th>
                                    <th>W%</th>
                                    <th>NET</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                    
                </div>
            </div>
        </div>
    </div>
</div>

<dialog id="team_modal_element" class="modal">
    <div class="modal-box w-11/12 max-w-4xl bg-base-100 border border-base-300 shadow-2xl">
        <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" id="modalCloseBtn">âœ•</button>
        </form>
        
        <div class="flex flex-col sm:flex-row items-center gap-6 border-b border-base-300 pb-4 mb-4">
            <div class="avatar p-2 bg-white rounded-full">
                <div class="w-20 rounded-full">
                    <img id="modalLogo" src="" alt="Team Logo" />
                </div>
            </div>
            <div class="flex-1 text-center sm:text-left">
                <div class="flex gap-2 justify-center sm:justify-start mb-2">
                    <select id="modalTeamSelect" class="select select-bordered select-sm select-ghost"></select>
                    <select id="modalSeasonSelect" class="select select-bordered select-sm select-ghost"></select>
                </div>
                <h3 class="text-lg font-bold text-base-content/60">Team Performance Report</h3>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div>
                <h3 class="divider divider-start text-xs text-base-content/50">æˆ°åŠ›é›·é” (Vs League)</h3>
                <div class="relative h-64 w-full">
                    <canvas id="radarChart"></canvas>
                </div>
            </div>
            <div class="flex flex-col gap-4">
                <div class="grid grid-cols-2 gap-4">
                    <div class="stats shadow bg-base-200">
                        <div class="stat place-items-center p-2">
                            <div class="stat-title text-xs">é€²æ”» (Off)</div>
                            <div class="stat-value text-xl text-primary" id="valOff">--</div>
                        </div>
                    </div>
                    <div class="stats shadow bg-base-200">
                        <div class="stat place-items-center p-2">
                            <div class="stat-title text-xs">é˜²å®ˆ (Def)</div>
                            <div class="stat-value text-xl text-secondary" id="valDef">--</div>
                        </div>
                    </div>
                    <div class="stats shadow bg-base-200">
                        <div class="stat place-items-center p-2">
                            <div class="stat-title text-xs">æ·¨å‹ (Net)</div>
                            <div class="stat-value text-xl text-accent" id="valNet">--</div>
                        </div>
                    </div>
                    <div class="stats shadow bg-base-200">
                        <div class="stat place-items-center p-2">
                            <div class="stat-title text-xs">ç¯€å¥ (Pace)</div>
                            <div class="stat-value text-xl" id="valPace">--</div>
                        </div>
                    </div>
                </div>

                <div class="bg-base-200 p-4 rounded-xl shadow mt-2">
                    <div class="flex justify-between text-xs mb-1">
                        <span>ğŸ  ä¸»å ´å‹ç‡</span>
                        <span id="homeWinVal" class="font-bold">--%</span>
                    </div>
                    <progress id="homeBar" class="progress progress-success w-full" value="0" max="100"></progress>
                    
                    <div class="flex justify-between text-xs mt-4 mb-1">
                        <span>âœˆï¸ å®¢å ´å‹ç‡</span>
                        <span id="awayWinVal" class="font-bold">--%</span>
                    </div>
                    <progress id="awayBar" class="progress progress-error w-full" value="0" max="100"></progress>
                </div>
            </div>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button id="modalBackdropBtn">close</button>
    </form>
</dialog>

<script>
document.addEventListener('DOMContentLoaded', () => {

    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTjU7f6Fg_rLg91OktseWM2qlgyRMwDYECHX34jGqCzEfVZWlGcPy5-oZ--x-wB1kKWOv-0bZaoZfPT/pub?output=csv';

    const TEAM_INFO = {
        "ATL": { color: "#E03A3E", conf: "East", div: "Southeast" },
        "BOS": { color: "#007A33", conf: "East", div: "Atlantic" },
        "BKN": { color: "#FFFFFF", conf: "East", div: "Atlantic" }, "BRK": { color: "#FFFFFF", conf: "East", div: "Atlantic" },
        "CHA": { color: "#1D1160", conf: "East", div: "Southeast" }, "CHO": { color: "#1D1160", conf: "East", div: "Southeast" },
        "CHI": { color: "#CE1141", conf: "East", div: "Central" },
        "CLE": { color: "#860038", conf: "East", div: "Central" },
        "DET": { color: "#C8102E", conf: "East", div: "Central" },
        "IND": { color: "#FDBB30", conf: "East", div: "Central" },
        "MIA": { color: "#98002E", conf: "East", div: "Southeast" },
        "MIL": { color: "#00471B", conf: "East", div: "Central" },
        "NYK": { color: "#F58426", conf: "East", div: "Atlantic" },
        "ORL": { color: "#0077C0", conf: "East", div: "Southeast" },
        "PHI": { color: "#006BB6", conf: "East", div: "Atlantic" },
        "TOR": { color: "#CE1141", conf: "East", div: "Atlantic" },
        "WAS": { color: "#002B5C", conf: "East", div: "Southeast" },
        "DAL": { color: "#00538C", conf: "West", div: "Southwest" },
        "DEN": { color: "#FEC524", conf: "West", div: "Northwest" },
        "GSW": { color: "#1D428A", conf: "West", div: "Pacific" },
        "HOU": { color: "#CE1141", conf: "West", div: "Southwest" },
        "LAC": { color: "#C8102E", conf: "West", div: "Pacific" },
        "LAL": { color: "#552583", conf: "West", div: "Pacific" },
        "MEM": { color: "#5D76A9", conf: "West", div: "Southwest" },
        "MIN": { color: "#236192", conf: "West", div: "Northwest" },
        "NOP": { color: "#0C2340", conf: "West", div: "Southwest" },
        "OKC": { color: "#007AC1", conf: "West", div: "Northwest" },
        "PHX": { color: "#E56020", conf: "West", div: "Pacific" }, "PHO": { color: "#E56020", conf: "West", div: "Pacific" },
        "POR": { color: "#E03A3E", conf: "West", div: "Northwest" },
        "SAC": { color: "#5A2D81", conf: "West", div: "Pacific" },
        "SAS": { color: "#C4CED4", conf: "West", div: "Southwest" },
        "UTA": { color: "#002B5C", conf: "West", div: "Northwest" }
    };

    const URL_MAP = {
        "UTA": "utah", "NOP": "no", "NYK": "ny", "SAS": "sa", "GSW": "gs", "WAS": "wsh",
        "BRK": "bkn", "CHO": "cha", "PHO": "phx"
    };

    const UNIQUE_TEAMS = [...new Set(Object.keys(TEAM_INFO).filter(t => !["BRK", "CHO", "PHO"].includes(t)))].sort();

    let rawData = [];
    let scatterChartInstance = null;
    let radarChartInstance = null;
    let currentStats = []; 
    let currentSeasonGames = [];
    const loadedLogos = {}; 

    // DataTables å¯¦ä¾‹
    let dataTableInstance = null;

    const safeFloat = (v) => {
        const f = parseFloat(v);
        return isNaN(f) ? 0 : f;
    };

    window.onload = function() {
        Papa.parse(CSV_URL, {
            download: true, header: true, dynamicTyping: true, skipEmptyLines: true,
            complete: function(results) {
                rawData = results.data;
                rawData.sort((a, b) => {
                    const dateA = a.date ? String(a.date) : "0";
                    const dateB = b.date ? String(b.date) : "0";
                    return dateA.localeCompare(dateB);
                });

                preloadAndResizeLogos().then(() => {
                    initSeasons();
                    initModalControls();
                    updateLastDate();
                    
                    const bind = (id, evt, func) => { const el = document.getElementById(id); if(el) el.addEventListener(evt, func); };
                    bind('seasonFilter', 'change', updateDashboard);
                    bind('confFilter', 'change', updateDashboard);
                    bind('divFilter', 'change', updateDashboard);
                    bind('metricFilter', 'change', updateDashboard);
                    bind('chartMode', 'change', updateDashboard);
                    bind('modalCloseBtn', 'click', closeModal);
                    bind('modalBackdropBtn', 'click', closeModal);
                    bind('modalTeamSelect', 'change', updateModalContent);
                    bind('modalSeasonSelect', 'change', updateModalContent);

                    updateDashboard(); 
                    document.getElementById('loader').style.display = 'none';
                    document.getElementById('main-content').classList.remove('hidden');
                });
            }
        });
    };

    // ... (preloadAndResizeLogos, updateLastDate, initSeasons, initModalControls, calculateStats ä¿æŒä¸è®Š) ...
    function preloadAndResizeLogos() {
        const promises = Object.keys(TEAM_INFO).map(teamAbbr => {
            return new Promise((resolve, reject) => {
                const urlAbbr = URL_MAP[teamAbbr] || teamAbbr.toLowerCase();
                const img = new Image();
                img.crossOrigin = "Anonymous"; 
                img.src = `https://a.espncdn.com/i/teamlogos/nba/500/scoreboard/${urlAbbr}.png`;
                img.onload = () => { 
                    const size = 40; 
                    const canvas = document.createElement('canvas');
                    canvas.width = size;
                    canvas.height = size;
                    const ctx = canvas.getContext('2d');
                    ctx.beginPath();
                    ctx.arc(size/2, size/2, size/2, 0, Math.PI * 2);
                    ctx.fillStyle = "white"; 
                    ctx.fill();
                    const padding = 5;
                    ctx.drawImage(img, padding, padding, size - padding*2, size - padding*2);
                    loadedLogos[teamAbbr] = canvas; 
                    resolve(); 
                };
                img.onerror = () => { resolve(); };
            });
        });
        return Promise.all(promises);
    }

    function updateLastDate() {
        const dates = rawData.map(r => r.date).filter(d => d);
        if (dates.length > 0) {
            document.querySelector('#last-update span').textContent = dates[dates.length - 1];
        }
    }

    function initSeasons() {
        const years = new Set(rawData.map(r => r.Season_Year).filter(y => y));
        const sorted = Array.from(years).sort().reverse();
        const mainSelect = document.getElementById('seasonFilter');
        mainSelect.innerHTML = "";
        sorted.forEach(y => {
            const opt = document.createElement('option');
            opt.value = y;
            opt.textContent = `${y} è³½å­£`;
            mainSelect.appendChild(opt);
        });
        if(sorted.length > 0) mainSelect.value = sorted[0];

        const modalSelect = document.getElementById('modalSeasonSelect');
        modalSelect.innerHTML = "";
        sorted.forEach(y => {
            const opt = document.createElement('option');
            opt.value = y;
            opt.textContent = `${y}`;
            modalSelect.appendChild(opt);
        });
    }

    function initModalControls() {
        const teamSelect = document.getElementById('modalTeamSelect');
        teamSelect.innerHTML = "";
        UNIQUE_TEAMS.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t;
            opt.textContent = t;
            teamSelect.appendChild(opt);
        });
    }

    function calculateStats(data) {
        const teams2 = {};
         const updateTeam2 = (name, offRtg, defRtg, pace) => {
            if (!teams2[name]) teams2[name] = { name: name, gp: 0, wins: 0, homeG: 0, homeW: 0, awayG: 0, awayW: 0, off: 0, def: 0, pace: 0 };
            teams2[name].gp++;
            if(offRtg) teams2[name].off = safeFloat(offRtg);
            if(defRtg) teams2[name].def = safeFloat(defRtg);
            if(pace) teams2[name].pace = safeFloat(pace);
        };

        data.forEach(row => {
             if (row.Team_Abbr) {
                updateTeam2(row.Team_Abbr, row.Before_Game_Avg_OffRtg, row.Before_Game_Avg_DefRtg, row.Before_Game_Avg_Pace);
                const t = teams2[row.Team_Abbr];
                t.homeG++;
                if (row.pts > row.opp_pts) { t.wins++; t.homeW++; }
            }
            if (row.Opp_Abbr) {
                updateTeam2(row.Opp_Abbr, row.Opp_Before_Game_Avg_OffRtg, row.Opp_Before_Game_Avg_DefRtg, row.Opp_Before_Game_Avg_Pace);
                const t = teams2[row.Opp_Abbr];
                t.awayG++;
                if (row.opp_pts > row.pts) { t.wins++; t.awayW++; }
            }
        });

        return Object.values(teams2).map(t => {
            const info = TEAM_INFO[t.name] || { color: "#999", conf: "Unknown", div: "Unknown" };
            const gp = t.gp || 1;
            const homeG = t.homeG || 1;
            const awayG = t.awayG || 1;
            const homeWinRate = (t.homeW / homeG * 100);
            const awayWinRate = (t.awayW / awayG * 100);
            return {
                name: t.name,
                winRate: (t.wins/gp*100).toFixed(1),
                homeWinRate: homeWinRate.toFixed(1),
                awayWinRate: awayWinRate.toFixed(1),
                offRtg: t.off.toFixed(1),
                defRtg: t.def.toFixed(1),
                netRtg: (t.off - t.def).toFixed(1),
                pace: t.pace.toFixed(1),
                color: info.color,
                conf: info.conf,
                div: info.div,
                pointStyle: loadedLogos[t.name] || 'circle', 
                _winRate: t.wins/gp,
                _homeWinRate: t.homeG > 0 ? t.homeW/t.homeG : 0,
                _awayWinRate: t.awayG > 0 ? t.awayW/t.awayG : 0,
                _netRtg: t.off - t.def,
                _offRtg: t.off,
                _defRtg: t.def,
                _pace: t.pace
            };
        });
    }

    function updateDashboard() {
        const season = document.getElementById('seasonFilter').value;
        const confFilter = document.getElementById('confFilter').value;
        const divFilter = document.getElementById('divFilter').value;
        const metric = document.getElementById('metricFilter').value;
        const chartMode = document.getElementById('chartMode').value;
        
        currentSeasonGames = rawData.filter(r => r.Season_Year == season);
        let stats = calculateStats(currentSeasonGames);
        currentStats = stats;

        let filteredStats = stats;
        if (confFilter !== 'ALL') filteredStats = filteredStats.filter(t => t.conf === confFilter);
        if (divFilter !== 'ALL') filteredStats = filteredStats.filter(t => t.div === divFilter);

        // åœ–è¡¨æ’åº
        let sortKey = "_winRate";
        if (metric === 'homeWinRate') sortKey = "_homeWinRate";
        if (metric === 'awayWinRate') sortKey = "_awayWinRate";
        if (metric === 'netRtg') sortKey = "_netRtg";
        filteredStats.sort((a, b) => b[sortKey] - a[sortKey]);

        renderScatterChart(filteredStats, chartMode);
        renderStatsTable(filteredStats, metric);
    }

    // --- ä¿®æ”¹ï¼šä½¿ç”¨ DataTables æ¸²æŸ“è¡¨æ ¼ ---
    function renderStatsTable(stats, currentMetric) {
        // æº–å‚™ DataTables éœ€è¦çš„æ•¸æ“šæ ¼å¼
        // æ¯ä¸€åˆ—æ˜¯ä¸€å€‹ç‰©ä»¶ï¼ŒåŒ…å«æˆ‘å€‘éœ€è¦é¡¯ç¤ºçš„å±¬æ€§
        const tableData = stats.map((t, index) => {
            let displayWinRate = t.winRate;
            if (currentMetric === 'homeWinRate') displayWinRate = t.homeWinRate;
            if (currentMetric === 'awayWinRate') displayWinRate = t.awayWinRate;
            
            return {
                rank: index + 1,
                teamObj: t, // å„²å­˜æ•´å€‹ç‰©ä»¶ä»¥ä¾¿ render å‡½æ•¸ä½¿ç”¨
                winRate: displayWinRate,
                netRtg: t.netRtg
            };
        });

        // å¦‚æœ DataTables å·²ç¶“å­˜åœ¨ï¼Œå…ˆéŠ·æ¯€å®ƒä»¥ä¾¿é‡æ–°åˆå§‹åŒ– (è™•ç†æ¬„ä½è®Šæ›´æˆ–è³‡æ–™æ›´æ–°)
        // æ³¨æ„ï¼šdestroy: true é›–ç„¶æ–¹ä¾¿ï¼Œä½†å¤§é‡æ•¸æ“šæ™‚å¯èƒ½æœ‰æ•ˆèƒ½å•é¡Œã€‚é€™è£¡æ•¸æ“šé‡å°ï¼Œæ²’å•é¡Œã€‚
        if ($.fn.DataTable.isDataTable('#statsTable')) {
            $('#statsTable').DataTable().destroy();
        }

        // åˆå§‹åŒ– DataTables
        dataTableInstance = $('#statsTable').DataTable({
            data: tableData,
            destroy: true, // å…è¨±é‡æ–°åˆå§‹åŒ–
            pageLength: 10, // æ¯é é¡¯ç¤ºå¹¾ç­†
            lengthChange: false, // éš±è— "é¡¯ç¤º X ç­†" çš„ä¸‹æ‹‰é¸å–® (ä¿æŒä»‹é¢ç°¡æ½”)
            searching: true, // é–‹å•Ÿæœå°‹
            ordering: true,  // é–‹å•Ÿæ’åº
            info: true,      // é¡¯ç¤º "Showing 1 to 10 of..."
            columns: [
                { data: 'rank', width: "10%" },
                { 
                    data: 'teamObj', 
                    title: "TEAM",
                    render: function(data, type, row) {
                        // è‡ªå®šç¾©æ¸²æŸ“ï¼šåŠ å…¥é¡è‰²é»é»
                        if (type === 'display') {
                            return `<div class="flex items-center gap-2"><span class="color-dot" style="background:${data.color}"></span>${data.name}</div>`;
                        }
                        return data.name; // ç”¨æ–¼æ’åºå’Œæœå°‹æ™‚åªå›å‚³éšŠå
                    }
                },
                { 
                    data: 'winRate', 
                    title: "W%",
                    render: function(data, type) {
                        return type === 'display' ? `<span class="font-bold">${data}%</span>` : data;
                    }
                },
                { 
                    data: 'netRtg', 
                    title: "NET",
                    render: function(data, type) {
                        if (type === 'display') {
                            const num = parseFloat(data);
                            const colorClass = num > 0 ? 'text-success font-bold' : 'text-error font-bold';
                            return `<span class="${colorClass}">${num > 0 ? '+' + data : data}</span>`;
                        }
                        return data;
                    }
                }
            ],
            // é»æ“Šè¡Œäº‹ä»¶ï¼šDataTables ç‰¹æœ‰å¯«æ³•
            createdRow: function(row, data, dataIndex) {
                $(row).on('click', () => {
                   openTeamModal(data.teamObj.name);
                });
                $(row).css('cursor', 'pointer');
            },
            // èªè¨€è¨­å®š (é¸ç”¨)
            language: {
                search: "æœå°‹çƒéšŠ:",
                paginate: {
                    next: "ä¸‹ä¸€é ",
                    previous: "ä¸Šä¸€é "
                },
                info: "é¡¯ç¤º _START_ åˆ° _END_ ç­† (å…± _TOTAL_ éšŠ)",
                emptyTable: "ç„¡ç¬¦åˆè³‡æ–™"
            }
        });
    }

    // ... (renderScatterChart, openTeamModal, closeModal, updateModalContent, renderRadarChart ä¿æŒä¸è®Š) ...
    function renderScatterChart(stats, mode) {
        const ctx = document.getElementById('scatterChart').getContext('2d');
        if (scatterChartInstance) scatterChartInstance.destroy();

        const chartTitle = document.getElementById('chartTitle');
        const chartDesc = document.getElementById('chartDesc');
        let points = [], xLabel, yLabel, revY = false;
        let lineStart, lineEnd;

        if (mode === 'homeAway') {
            chartTitle.textContent = "Home vs Away Performance";
            chartDesc.textContent = "Xè»¸: ä¸»å ´å‹ç‡ | Yè»¸: å®¢å ´å‹ç‡ | è™›ç·šä¸Šæ–¹ç‚ºå®¢å ´æ›´å¼·";
            xLabel = "Home Win% (ä¸»å ´å‹ç‡)"; 
            yLabel = "Away Win% (å®¢å ´å‹ç‡)";
            points = stats.map(t => ({ x: t._homeWinRate * 100, y: t._awayWinRate * 100, team: t.name, pointStyle: t.pointStyle }));
            lineStart = {x: 0, y: 0}; lineEnd = {x: 100, y: 100};
        } else {
            chartTitle.textContent = "Efficiency Landscape";
            chartDesc.textContent = "Xè»¸: é€²æ”»æ•ˆç‡ | Yè»¸: é˜²å®ˆæ•ˆç‡ | è™›ç·šå³ä¸Šæ–¹ç‚ºå¼·æ¬Š (æ·¨å‹åˆ† > 0)";
            xLabel = "Off Rtg (é€²æ”»)"; 
            yLabel = "Def Rtg (é˜²å®ˆ)"; 
            revY = true;
            points = stats.map(t => ({ x: t._offRtg, y: t._defRtg, team: t.name, pointStyle: t.pointStyle }));
            const allVals = points.map(p => p.x).concat(points.map(p => p.y));
            const minVal = Math.floor(Math.min(...allVals) - 2);
            const maxVal = Math.ceil(Math.max(...allVals) + 2);
            lineStart = {x: minVal, y: minVal}; lineEnd = {x: maxVal, y: maxVal};
        }

        const referenceLine = {
            label: '1:1 Reference',
            data: [lineStart, lineEnd],
            type: 'line',
            borderColor: '#555',
            borderWidth: 2,
            borderDash: [5, 5],
            pointRadius: 0,
            fill: false,
            zIndex: 0
        };

        Chart.defaults.color = '#a6adbb'; 
        Chart.defaults.borderColor = '#333';

        scatterChartInstance = new Chart(ctx, {
            type: 'scatter',
            data: {
                labels: stats.map(t => t.name),
                datasets: [
                    {
                        label: 'Team Data',
                        data: points,
                        pointStyle: (ctx) => ctx.raw.pointStyle, 
                        pointRadius: 6,       
                        pointHoverRadius: 10,
                        borderWidth: 0,
                        zIndex: 2
                    },
                    referenceLine
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                onClick: (evt, elements) => {
                    if (elements.length > 0 && elements[0].datasetIndex === 0) {
                        openTeamModal(stats[elements[0].index].name);
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(ctx) { 
                                if(ctx.dataset.type === 'line') return null;
                                const p = ctx.raw;
                                return `${p.team}: X=${p.x.toFixed(1)}, Y=${p.y.toFixed(1)}`; 
                            }
                        },
                        backgroundColor: 'rgba(0,0,0,0.9)',
                        titleFont: { size: 14 }
                    }
                },
                scales: {
                    x: { title: { display: true, text: xLabel, color: '#aaa' }, grid: { color: '#333' } },
                    y: { 
                        title: { display: true, text: yLabel, color: '#aaa' }, 
                        grid: { color: '#333' }, 
                        reverse: revY 
                    }
                }
            }
        });
    }

    function openTeamModal(teamName) {
        const currentSeason = document.getElementById('seasonFilter').value;
        document.getElementById('modalTeamSelect').value = teamName;
        document.getElementById('modalSeasonSelect').value = currentSeason;
        const modal = document.getElementById('team_modal_element');
        modal.classList.add('modal-open');
        updateModalContent();
    }

    function closeModal() {
        const modal = document.getElementById('team_modal_element');
        modal.classList.remove('modal-open');
    }

    function updateModalContent() {
        const selectedTeam = document.getElementById('modalTeamSelect').value;
        const selectedSeason = document.getElementById('modalSeasonSelect').value;
        const modalSeasonGames = rawData.filter(r => r.Season_Year == selectedSeason);
        const seasonStats = calculateStats(modalSeasonGames);
        const teamData = seasonStats.find(t => t.name === selectedTeam);

        if (!teamData) { return; }

        document.getElementById('modalLogo').src = `https://a.espncdn.com/i/teamlogos/nba/500/scoreboard/${(URL_MAP[selectedTeam]||selectedTeam).toLowerCase()}.png`;
        document.getElementById('valOff').textContent = teamData.offRtg;
        document.getElementById('valDef').textContent = teamData.defRtg;
        document.getElementById('valNet').textContent = (teamData.netRtg > 0 ? '+':'') + teamData.netRtg;
        document.getElementById('valPace').textContent = teamData.pace;

        const homePct = Math.round(teamData._homeWinRate * 100);
        const awayPct = Math.round(teamData._awayWinRate * 100);

        let homeW=0, homeG=0, awayW=0, awayG=0;
        modalSeasonGames.forEach(g => {
            if (g.Team_Abbr === selectedTeam) {
                homeG++;
                if (g.pts > g.opp_pts) homeW++;
            }
            else if (g.Opp_Abbr === selectedTeam) {
                awayG++;
                if (g.opp_pts > g.pts) awayW++; 
            }
        });

        document.getElementById('homeWinVal').textContent = `${homePct}% (${homeW}-${homeG-homeW})`;
        document.getElementById('homeBar').value = homePct;
        document.getElementById('awayWinVal').textContent = `${awayPct}% (${awayW}-${awayG-awayW})`;
        document.getElementById('awayBar').value = awayPct;

        renderRadarChart(teamData, seasonStats);
    }

    function renderRadarChart(teamData, allStats) {
        const ctx = document.getElementById('radarChart').getContext('2d');
        if (radarChartInstance) radarChartInstance.destroy();

        const validStats = allStats.filter(t => !isNaN(t._offRtg) && !isNaN(t._defRtg));
        
        const maxOff = Math.max(...validStats.map(t => t._offRtg)) || 120;
        const minOff = Math.min(...validStats.map(t => t._offRtg)) || 100;
        const maxDef = Math.max(...validStats.map(t => t._defRtg)) || 120; 
        const minDef = Math.min(...validStats.map(t => t._defRtg)) || 100; 
        const maxWin = Math.max(...validStats.map(t => t._winRate)) || 1;
        const minWin = Math.min(...validStats.map(t => t._winRate)) || 0;
        const maxNet = Math.max(...validStats.map(t => t._netRtg)) || 15; 
        const minNet = Math.min(...validStats.map(t => t._netRtg)) || -15;
        const maxPace = Math.max(...validStats.map(t => t._pace)) || 105; 
        const minPace = Math.min(...validStats.map(t => t._pace)) || 90;

        const norm = (val, min, max) => {
            if (max === min) return 50;
            let res = (val - min) / (max - min) * 100;
            return Math.max(0, Math.min(100, res)); 
        };
        const normRev = (val, min, max) => {
            if (max === min) return 50;
            let res = (max - val) / (max - min) * 100;
            return Math.max(0, Math.min(100, res));
        };

        const scoreOff = norm(teamData._offRtg, minOff, maxOff);
        const scoreDef = normRev(teamData._defRtg, minDef, maxDef);
        const scoreWin = norm(teamData._winRate, minWin, maxWin);
        const scoreNet = norm(teamData._netRtg, minNet, maxNet); 
        const scorePace = norm(teamData._pace, minPace, maxPace);

        radarChartInstance = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['é€²æ”»', 'é˜²å®ˆ', 'å‹ç‡', 'æ·¨å‹åˆ†', 'ç¯€å¥'],
                datasets: [
                    {
                        label: teamData.name,
                        data: [scoreOff, scoreDef, scoreWin, scoreNet, scorePace],
                        backgroundColor: 'rgba(59, 130, 246, 0.5)',
                        borderColor: '#3b82f6',
                        pointBackgroundColor: '#fff',
                        zIndex: 2
                    },
                    {
                        label: 'League Avg',
                        data: [50, 50, 50, 50, 50],
                        borderColor: '#666',
                        borderDash: [5, 5],
                        borderWidth: 1,
                        pointRadius: 0,
                        backgroundColor: 'transparent',
                        zIndex: 1
                    }
                ]
            },
            options: {
                maintainAspectRatio: false,
                scales: {
                    r: {
                        angleLines: { color: '#777' },
                        grid: { color: '#777' },
                        pointLabels: { color: '#ccc', font: { size: 12 } },
                        suggestedMin: 0,
                        suggestedMax: 100,
                        ticks: { display: false }
                    }
                },
                plugins: { legend: { display: false } }
            }
        });
    }

});
</script>

</body>
</html>
