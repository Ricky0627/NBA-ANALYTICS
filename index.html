<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NBA æˆ°æƒ…å®¤ (v25.0 åŸºæº–ç·šç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --accent: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }
        body { font-family: 'Roboto', sans-serif; background-color: var(--bg-color); color: var(--text-main); margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        
        header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #333; }
        h1 { margin: 0; font-weight: 700; color: white; letter-spacing: 1px; }
        .badge { background: linear-gradient(135deg, #FFD700, #FFA500); color: #000; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight:bold; vertical-align: middle; }
        .data-date { font-size: 14px; color: var(--text-muted); margin-top: 5px; }
        .data-date span { color: var(--accent); font-weight: bold; }

        .controls { 
            display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; 
            background: #252525; padding: 15px; border-radius: 8px; border: 1px solid #333;
        }
        .control-group { display: flex; flex-direction: column; gap: 5px; }
        .control-group label { font-size: 12px; color: var(--text-muted); font-weight: bold; }
        select { background: #333; color: white; border: 1px solid #444; padding: 8px 12px; border-radius: 4px; font-size: 14px; outline: none; min-width: 140px; }
        select:hover { border-color: var(--accent); }

        .grid-dashboard { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); height: 100%; box-sizing: border-box; }
        .card h3 { margin-top: 0; color: var(--text-muted); font-size: 14px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; }

        .chart-container { position: relative; height: 600px; width: 100%; }
        .table-container { overflow-x: auto; max-height: 600px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { text-align: left; padding: 12px; background: #252525; color: var(--text-muted); position: sticky; top: 0; }
        td { padding: 12px; border-bottom: 1px solid #333; vertical-align: middle; }
        tr:hover { background: #2a2a2a; }
        .team-name { font-weight: bold; color: white; display: flex; align-items: center; }
        
        .val-high { color: var(--success); }
        .val-low { color: var(--danger); }
        .color-dot { display:inline-block; width:8px; height:8px; border-radius:50%; margin-right:8px; }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 1000; display: none;
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: #252525; width: 90%; max-width: 800px; border-radius: 12px; padding: 30px;
            position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: grid; grid-template-columns: 1fr 1fr; gap: 30px;
        }
        .close-btn {
            position: absolute; top: 15px; right: 20px; font-size: 24px; color: #888; cursor: pointer; z-index: 10;
        }
        .close-btn:hover { color: white; }
        
        .team-header { grid-column: 1 / -1; display: flex; align-items: center; gap: 20px; border-bottom: 1px solid #444; padding-bottom: 15px; }
        .team-logo-lg { width: 80px; height: 80px; background: white; border-radius: 50%; padding: 5px; }
        
        .modal-controls { display: flex; gap: 10px; margin-top: 5px; }
        .modal-select { background: #444; border: 1px solid #555; padding: 5px 10px; color: white; border-radius: 4px; font-size: 16px; font-weight: bold; }

        .stat-box { background: #333; padding: 15px; border-radius: 8px; text-align: center; }
        .stat-val { font-size: 20px; font-weight: bold; color: white; }
        .stat-label { font-size: 12px; color: #aaa; margin-top: 5px; }
        .split-bar { height: 8px; background: #444; border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .split-fill { height: 100%; background: var(--accent); }

        #loader { text-align: center; margin-top: 50px; color: var(--accent); }
        @media (max-width: 1024px) { 
            .grid-dashboard { grid-template-columns: 1fr; } 
            .modal-content { grid-template-columns: 1fr; max-height: 90vh; overflow-y: auto; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1>NBA ANALYTICS <span class="badge">V25.0</span></h1>
            <p style="color:var(--text-muted); margin:5px 0 0;">With 1:1 Reference Line 

[Image of chart with reference line]
</p>
        </div>
        <div style="text-align: right;">
            <div id="status" style="font-size:14px; color:var(--success);">â— Live Data</div>
            <div id="last-update" class="data-date">æ•¸æ“šçµ±è¨ˆæˆªè‡³: <span>è®€å–ä¸­...</span></div>
        </div>
    </header>

    <div id="loader"><h2>âŸ³ æ­£åœ¨é€£ç·šè³‡æ–™åº«...</h2></div>

    <div id="main-content" style="display:none;">
        <div class="controls">
            <div class="control-group">
                <label>ğŸ“… è³½å­£ (Season)</label>
                <select id="seasonFilter"><option value="ALL">è¼‰å…¥ä¸­...</option></select>
            </div>
            
            <div class="control-group">
                <label>ğŸ“ˆ åœ–è¡¨æ¨¡å¼ (Chart Mode)</label>
                <select id="chartMode">
                    <option value="efficiency">ğŸ€ æ”»å®ˆæ•ˆç‡ (Off vs Def)</option>
                    <option value="homeAway">ğŸ  ä¸»å®¢æˆ°ç¸¾ (Home vs Away)</option>
                </select>
            </div>

            <div class="control-group">
                <label>ğŸŒ åˆ†å€ (Conference)</label>
                <select id="confFilter">
                    <option value="ALL">å…¨éƒ¨ (All)</option>
                    <option value="East">æ±å€ (Eastern)</option>
                    <option value="West">è¥¿å€ (Western)</option>
                </select>
            </div>

            <div class="control-group">
                <label>ğŸš© åˆ†çµ„ (Division)</label>
                <select id="divFilter">
                    <option value="ALL">å…¨éƒ¨ (All)</option>
                    <optgroup label="æ±å€ (East)">
                        <option value="Atlantic">å¤§è¥¿æ´‹çµ„ (Atlantic)</option>
                        <option value="Central">ä¸­å¤®çµ„ (Central)</option>
                        <option value="Southeast">æ±å—çµ„ (Southeast)</option>
                    </optgroup>
                    <optgroup label="è¥¿å€ (West)">
                        <option value="Northwest">è¥¿åŒ—çµ„ (Northwest)</option>
                        <option value="Pacific">å¤ªå¹³æ´‹çµ„ (Pacific)</option>
                        <option value="Southwest">è¥¿å—çµ„ (Southwest)</option>
                    </optgroup>
                </select>
            </div>

            <div class="control-group">
                <label>ğŸ“Š æ’åºä¾æ“š (Sort By)</label>
                <select id="metricFilter">
                    <option value="winRate">ç¸½å‹ç‡ (Overall Win%)</option>
                    <option value="homeWinRate">ä¸»å ´å‹ç‡ (Home Win%)</option>
                    <option value="awayWinRate">å®¢å ´å‹ç‡ (Away Win%)</option>
                    <option value="netRtg">æ·¨æ•ˆç‡å€¼ (Net Rtg)</option>
                    <option value="offRtg">é€²æ”»æ•ˆç‡ (Off Rtg)</option>
                    <option value="pace">æ¯”è³½ç¯€å¥ (Pace)</option>
                </select>
            </div>
        </div>

        <div class="grid-dashboard">
            <div class="card">
                <h3 id="chartTitle">Efficiency Landscape</h3>
                <p id="chartDesc" style="font-size:12px; color:#888; margin-top:-10px;">Xè»¸: é€²æ”»æ•ˆç‡ | Yè»¸: é˜²å®ˆæ•ˆç‡ | è™›ç·šç‚ºå¹³è¡¡ç·š (y=x)</p>
                <div class="chart-container">
                    <canvas id="scatterChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3>Team Rankings</h3>
                <div class="table-container">
                    <table id="statsTable">
                        <thead>
                            <tr><th>RK</th><th>TEAM</th><th id="th-winrate">W%</th><th>NET RTG</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="teamModal">
    <div class="modal-content">
        <span class="close-btn" id="closeBtn">Ã—</span>
        
        <div class="team-header">
            <img id="modalLogo" class="team-logo-lg" src="" alt="Team Logo">
            <div>
                <div class="modal-controls">
                    <select id="modalTeamSelect" class="modal-select"></select>
                    <select id="modalSeasonSelect" class="modal-select"></select>
                </div>
                <p style="margin:5px 0 0; color:#888; font-size:13px;">Team Performance Report</p>
            </div>
        </div>

        <div>
            <h3 style="color:#aaa; border-bottom:1px solid #444; padding-bottom:5px;">ğŸ“Š æˆ°åŠ›é›·é” (Vs League)</h3>
            <div style="position: relative; height:300px; width:100%;">
                <canvas id="radarChart"></canvas>
            </div>
            <p style="font-size:12px; color:#666; text-align:center;">*é˜²å®ˆæ•¸å€¼åè½‰ï¼šè¶Šå¤–åœˆä»£è¡¨å¤±åˆ†è¶Šå°‘(é˜²å®ˆè¶Šå¥½)</p>
        </div>

        <div style="display:flex; flex-direction:column; gap:20px;">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div class="stat-box">
                    <div class="stat-val" id="valOff">--</div>
                    <div class="stat-label">é€²æ”» (Off Rtg)</div>
                </div>
                <div class="stat-box">
                    <div class="stat-val" id="valDef">--</div>
                    <div class="stat-label">é˜²å®ˆ (Def Rtg)</div>
                </div>
                <div class="stat-box">
                    <div class="stat-val" id="valNet">--</div>
                    <div class="stat-label">æ·¨å‹ (Net Rtg)</div>
                </div>
                <div class="stat-box">
                    <div class="stat-val" id="valPace">--</div>
                    <div class="stat-label">ç¯€å¥ (Pace)</div>
                </div>
            </div>

            <div class="stat-box" style="text-align:left;">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span style="color:#aaa; font-size:12px;">ä¸»å ´å‹ç‡ (Home)</span>
                    <span id="homeWinVal" style="color:white; font-weight:bold;">--%</span>
                </div>
                <div class="split-bar"><div id="homeBar" class="split-fill" style="width:0%"></div></div>
                
                <div style="display:flex; justify-content:space-between; margin-top:15px; margin-bottom:5px;">
                    <span style="color:#aaa; font-size:12px;">å®¢å ´å‹ç‡ (Away)</span>
                    <span id="awayWinVal" style="color:white; font-weight:bold;">--%</span>
                </div>
                <div class="split-bar"><div id="awayBar" class="split-fill" style="width:0%; background:#ef4444;"></div></div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTjU7f6Fg_rLg91OktseWM2qlgyRMwDYECHX34jGqCzEfVZWlGcPy5-oZ--x-wB1kKWOv-0bZaoZfPT/pub?output=csv';

    const TEAM_INFO = {
        "ATL": { color: "#E03A3E", conf: "East", div: "Southeast" },
        "BOS": { color: "#007A33", conf: "East", div: "Atlantic" },
        "BKN": { color: "#FFFFFF", conf: "East", div: "Atlantic" }, "BRK": { color: "#FFFFFF", conf: "East", div: "Atlantic" },
        "CHA": { color: "#1D1160", conf: "East", div: "Southeast" }, "CHO": { color: "#1D1160", conf: "East", div: "Southeast" },
        "CHI": { color: "#CE1141", conf: "East", div: "Central" },
        "CLE": { color: "#860038", conf: "East", div: "Central" },
        "DET": { color: "#C8102E", conf: "East", div: "Central" },
        "IND": { color: "#FDBB30", conf: "East", div: "Central" },
        "MIA": { color: "#98002E", conf: "East", div: "Southeast" },
        "MIL": { color: "#00471B", conf: "East", div: "Central" },
        "NYK": { color: "#F58426", conf: "East", div: "Atlantic" },
        "ORL": { color: "#0077C0", conf: "East", div: "Southeast" },
        "PHI": { color: "#006BB6", conf: "East", div: "Atlantic" },
        "TOR": { color: "#CE1141", conf: "East", div: "Atlantic" },
        "WAS": { color: "#002B5C", conf: "East", div: "Southeast" },
        "DAL": { color: "#00538C", conf: "West", div: "Southwest" },
        "DEN": { color: "#FEC524", conf: "West", div: "Northwest" },
        "GSW": { color: "#1D428A", conf: "West", div: "Pacific" },
        "HOU": { color: "#CE1141", conf: "West", div: "Southwest" },
        "LAC": { color: "#C8102E", conf: "West", div: "Pacific" },
        "LAL": { color: "#552583", conf: "West", div: "Pacific" },
        "MEM": { color: "#5D76A9", conf: "West", div: "Southwest" },
        "MIN": { color: "#236192", conf: "West", div: "Northwest" },
        "NOP": { color: "#0C2340", conf: "West", div: "Southwest" },
        "OKC": { color: "#007AC1", conf: "West", div: "Northwest" },
        "PHX": { color: "#E56020", conf: "West", div: "Pacific" }, "PHO": { color: "#E56020", conf: "West", div: "Pacific" },
        "POR": { color: "#E03A3E", conf: "West", div: "Northwest" },
        "SAC": { color: "#5A2D81", conf: "West", div: "Pacific" },
        "SAS": { color: "#C4CED4", conf: "West", div: "Southwest" },
        "UTA": { color: "#002B5C", conf: "West", div: "Northwest" }
    };

    const URL_MAP = {
        "UTA": "utah", "NOP": "no", "NYK": "ny", "SAS": "sa", "GSW": "gs", "WAS": "wsh",
        "BRK": "bkn", "CHO": "cha", "PHO": "phx"
    };

    const UNIQUE_TEAMS = [...new Set(Object.keys(TEAM_INFO).filter(t => !["BRK", "CHO", "PHO"].includes(t)))].sort();

    let rawData = [];
    let scatterChartInstance = null;
    let radarChartInstance = null;
    let currentStats = []; 
    let currentSeasonGames = [];
    const loadedLogos = {}; 

    const safeFloat = (v) => {
        const f = parseFloat(v);
        return isNaN(f) ? 0 : f;
    };

    window.onload = function() {
        Papa.parse(CSV_URL, {
            download: true, header: true, dynamicTyping: true, skipEmptyLines: true,
            complete: function(results) {
                rawData = results.data;
                rawData.sort((a, b) => {
                    const dateA = a.date ? String(a.date) : "0";
                    const dateB = b.date ? String(b.date) : "0";
                    return dateA.localeCompare(dateB);
                });

                preloadAndResizeLogos().then(() => {
                    initSeasons();
                    initModalControls();
                    updateLastDate();
                    
                    const bind = (id, evt, func) => { const el = document.getElementById(id); if(el) el.addEventListener(evt, func); };
                    bind('seasonFilter', 'change', updateDashboard);
                    bind('confFilter', 'change', updateDashboard);
                    bind('divFilter', 'change', updateDashboard);
                    bind('metricFilter', 'change', updateDashboard);
                    bind('chartMode', 'change', updateDashboard);
                    
                    bind('teamModal', 'click', (e) => { if(e.target.id === 'teamModal') closeModal(); });
                    bind('closeBtn', 'click', closeModal);
                    bind('modalTeamSelect', 'change', updateModalContent);
                    bind('modalSeasonSelect', 'change', updateModalContent);

                    updateDashboard(); 
                    document.getElementById('loader').style.display = 'none';
                    document.getElementById('main-content').style.display = 'block';
                });
            }
        });
    };

    function preloadAndResizeLogos() {
        const promises = Object.keys(TEAM_INFO).map(teamAbbr => {
            return new Promise((resolve, reject) => {
                const urlAbbr = URL_MAP[teamAbbr] || teamAbbr.toLowerCase();
                const img = new Image();
                img.crossOrigin = "Anonymous"; 
                img.src = `https://a.espncdn.com/i/teamlogos/nba/500/scoreboard/${urlAbbr}.png`;
                img.onload = () => { 
                    const size = 40; 
                    const canvas = document.createElement('canvas');
                    canvas.width = size;
                    canvas.height = size;
                    const ctx = canvas.getContext('2d');
                    ctx.beginPath();
                    ctx.arc(size/2, size/2, size/2, 0, Math.PI * 2);
                    ctx.fillStyle = "white"; 
                    ctx.fill();
                    const padding = 5;
                    ctx.drawImage(img, padding, padding, size - padding*2, size - padding*2);
                    loadedLogos[teamAbbr] = canvas; 
                    resolve(); 
                };
                img.onerror = () => { resolve(); };
            });
        });
        return Promise.all(promises);
    }

    function updateLastDate() {
        const dates = rawData.map(r => r.date).filter(d => d);
        if (dates.length > 0) {
            document.querySelector('#last-update span').textContent = dates[dates.length - 1];
        }
    }

    function initSeasons() {
        const years = new Set(rawData.map(r => r.Season_Year).filter(y => y));
        const sorted = Array.from(years).sort().reverse();
        
        const mainSelect = document.getElementById('seasonFilter');
        mainSelect.innerHTML = "";
        sorted.forEach(y => {
            const opt = document.createElement('option');
            opt.value = y;
            opt.textContent = `${y} è³½å­£`;
            mainSelect.appendChild(opt);
        });
        if(sorted.length > 0) mainSelect.value = sorted[0];

        const modalSelect = document.getElementById('modalSeasonSelect');
        modalSelect.innerHTML = "";
        sorted.forEach(y => {
            const opt = document.createElement('option');
            opt.value = y;
            opt.textContent = `${y}`;
            modalSelect.appendChild(opt);
        });
    }

    function initModalControls() {
        const teamSelect = document.getElementById('modalTeamSelect');
        teamSelect.innerHTML = "";
        UNIQUE_TEAMS.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t;
            opt.textContent = t;
            teamSelect.appendChild(opt);
        });
    }

    function calculateStats(data) {
        const teams = {};
        
        const updateTeam = (name, offRtg, defRtg, pace) => {
            if (!teams[name]) teams[name] = { 
                name: name, gp: 0, wins: 0, 
                homeG: 0, homeW: 0, awayG: 0, awayW: 0,
                off: 0, def: 0, pace: 0 
            };
            teams[name].gp++;
            
            if(offRtg) teams[name].off = safeFloat(offRtg);
            if(defRtg) teams[name].def = safeFloat(defRtg);
            if(pace) teams[name].pace = safeFloat(pace);
        };

        data.forEach(row => {
            if (row.Team_Abbr) {
                updateTeam(row.Team_Abbr, row.Before_Game_Avg_OffRtg, row.Before_Game_Avg_DefRtg, row.Before_Game_Avg_Pace);
                const t = teams[row.Team_Abbr];
                t.homeG++;
                if (row.pts > row.opp_pts) {
                    t.wins++;
                    t.homeW++;
                }
            }
            if (row.Opp_Abbr) {
                updateTeam(row.Opp_Abbr, row.Opp_Before_Game_Avg_OffRtg, row.Opp_Before_Game_Avg_DefRtg, row.Opp_Before_Game_Avg_Pace);
                const t = teams[row.Opp_Abbr];
                t.awayG++;
                if (row.opp_pts > row.pts) {
                    t.wins++;
                    t.awayW++;
                }
            }
        });

        return Object.values(teams).map(t => {
            const info = TEAM_INFO[t.name] || { color: "#999", conf: "Unknown", div: "Unknown" };
            const gp = t.gp || 1;
            const homeG = t.homeG || 1;
            const awayG = t.awayG || 1;

            const homeWinRate = (t.homeW / homeG * 100);
            const awayWinRate = (t.awayW / awayG * 100);

            return {
                name: t.name,
                winRate: (t.wins/gp*100).toFixed(1),
                homeWinRate: homeWinRate.toFixed(1),
                awayWinRate: awayWinRate.toFixed(1),
                offRtg: t.off.toFixed(1),
                defRtg: t.def.toFixed(1),
                netRtg: (t.off - t.def).toFixed(1),
                pace: t.pace.toFixed(1),
                color: info.color,
                conf: info.conf,
                div: info.div,
                pointStyle: loadedLogos[t.name] || 'circle', 
                
                _winRate: t.wins/gp,
                _homeWinRate: t.homeG > 0 ? t.homeW/t.homeG : 0,
                _awayWinRate: t.awayG > 0 ? t.awayW/t.awayG : 0,
                _netRtg: t.off - t.def,
                _offRtg: t.off,
                _defRtg: t.def,
                _pace: t.pace
            };
        });
    }

    function updateDashboard() {
        const season = document.getElementById('seasonFilter').value;
        const confFilter = document.getElementById('confFilter').value;
        const divFilter = document.getElementById('divFilter').value;
        const metric = document.getElementById('metricFilter').value;
        const chartMode = document.getElementById('chartMode').value;
        
        currentSeasonGames = rawData.filter(r => r.Season_Year == season);
        let stats = calculateStats(currentSeasonGames);
        currentStats = stats;

        let filteredStats = stats;
        if (confFilter !== 'ALL') filteredStats = filteredStats.filter(t => t.conf === confFilter);
        if (divFilter !== 'ALL') filteredStats = filteredStats.filter(t => t.div === divFilter);

        let sortKey = "_winRate";
        if (metric === 'homeWinRate') sortKey = "_homeWinRate";
        if (metric === 'awayWinRate') sortKey = "_awayWinRate";
        if (metric === 'netRtg') sortKey = "_netRtg";
        if (metric === 'offRtg') sortKey = "_offRtg";
        if (metric === 'pace') sortKey = "_pace";

        filteredStats.sort((a, b) => b[sortKey] - a[sortKey]);

        renderScatterChart(filteredStats, chartMode);
        renderStatsTable(filteredStats, metric);
    }

    function renderScatterChart(stats, mode) {
        const ctx = document.getElementById('scatterChart').getContext('2d');
        if (scatterChartInstance) scatterChartInstance.destroy();

        const chartTitle = document.getElementById('chartTitle');
        const chartDesc = document.getElementById('chartDesc');
        let points = [], xLabel, yLabel, revY = false;
        
        // ğŸ”¥ å‹•æ…‹åŸºæº–ç·šè¨ˆç®—
        let lineStart, lineEnd;

        if (mode === 'homeAway') {
            chartTitle.textContent = "Home vs Away Performance (ä¸»å®¢å ´æˆ°ç¸¾)";
            chartDesc.textContent = "Xè»¸: ä¸»å ´å‹ç‡ | Yè»¸: å®¢å ´å‹ç‡ | è™›ç·šä¸Šæ–¹ç‚ºå®¢å ´æ›´å¼·";
            xLabel = "Home Win% (ä¸»å ´å‹ç‡)"; 
            yLabel = "Away Win% (å®¢å ´å‹ç‡)";
            
            points = stats.map(t => ({ x: t._homeWinRate * 100, y: t._awayWinRate * 100, team: t.name, pointStyle: t.pointStyle }));
            lineStart = {x: 0, y: 0}; lineEnd = {x: 100, y: 100};
        } else {
            chartTitle.textContent = "Efficiency Landscape (æ”»å®ˆæ•ˆç‡)";
            chartDesc.textContent = "Xè»¸: é€²æ”»æ•ˆç‡ | Yè»¸: é˜²å®ˆæ•ˆç‡ | è™›ç·šå³ä¸Šæ–¹ç‚ºå¼·æ¬Š (æ·¨å‹åˆ† > 0)";
            xLabel = "Off Rtg (é€²æ”»)"; 
            yLabel = "Def Rtg (é˜²å®ˆ)"; 
            revY = true;

            points = stats.map(t => ({ x: t._offRtg, y: t._defRtg, team: t.name, pointStyle: t.pointStyle }));
            
            // è‡ªå‹•è¨ˆç®—ç¯„åœ
            const allVals = points.map(p => p.x).concat(points.map(p => p.y));
            const minVal = Math.floor(Math.min(...allVals) - 2);
            const maxVal = Math.ceil(Math.max(...allVals) + 2);
            lineStart = {x: minVal, y: minVal}; lineEnd = {x: maxVal, y: maxVal};
        }

        // ğŸ”¥ æ–°å¢åŸºæº–ç·š Dataset
        const referenceLine = {
            label: '1:1 Reference',
            data: [lineStart, lineEnd],
            type: 'line',
            borderColor: '#555',
            borderWidth: 2,
            borderDash: [5, 5],
            pointRadius: 0,
            fill: false,
            zIndex: 0
        };

        scatterChartInstance = new Chart(ctx, {
            type: 'scatter',
            data: {
                labels: stats.map(t => t.name),
                datasets: [
                    {
                        label: 'Team Data',
                        data: points,
                        pointStyle: (ctx) => ctx.raw.pointStyle, 
                        pointRadius: 6,       
                        pointHoverRadius: 10,
                        borderWidth: 0,
                        zIndex: 2
                    },
                    referenceLine
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                onClick: (evt, elements) => {
                    if (elements.length > 0 && elements[0].datasetIndex === 0) {
                        openTeamModal(stats[elements[0].index].name);
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(ctx) { 
                                if(ctx.dataset.type === 'line') return null;
                                const p = ctx.raw;
                                return `${p.team}: X=${p.x.toFixed(1)}, Y=${p.y.toFixed(1)}`; 
                            }
                        },
                        backgroundColor: 'rgba(0,0,0,0.9)',
                        titleFont: { size: 14 }
                    }
                },
                scales: {
                    x: { title: { display: true, text: xLabel, color: '#aaa' }, grid: { color: '#333' } },
                    y: { 
                        title: { display: true, text: yLabel, color: '#aaa' }, 
                        grid: { color: '#333' }, 
                        reverse: revY 
                    }
                }
            }
        });
    }

    function renderStatsTable(stats, currentMetric) {
        const tbody = document.querySelector("#statsTable tbody");
        const thWinRate = document.getElementById('th-winrate');
        
        if (currentMetric === 'homeWinRate') {
            thWinRate.textContent = "HOME W%";
            thWinRate.style.color = "var(--success)";
        } else if (currentMetric === 'awayWinRate') {
            thWinRate.textContent = "AWAY W%";
            thWinRate.style.color = "var(--danger)";
        } else {
            thWinRate.textContent = "W%";
            thWinRate.style.color = "var(--text-muted)";
        }

        tbody.innerHTML = "";
        stats.forEach((t, i) => {
            const netClass = t.netRtg > 0 ? 'val-high' : 'val-low';
            
            let displayWinRate = t.winRate;
            if (currentMetric === 'homeWinRate') displayWinRate = t.homeWinRate;
            if (currentMetric === 'awayWinRate') displayWinRate = t.awayWinRate;

            tbody.innerHTML += `<tr>
                <td style="color:#666">${i+1}</td>
                <td class="team-name"><span class="color-dot" style="background:${t.color}"></span>${t.name}</td>
                <td style="font-weight:bold">${displayWinRate}%</td>
                <td class="${netClass}">${t.netRtg > 0 ? '+'+t.netRtg : t.netRtg}</td>
            </tr>`;
        });
    }

    function openTeamModal(teamName) {
        const currentSeason = document.getElementById('seasonFilter').value;
        document.getElementById('modalTeamSelect').value = teamName;
        document.getElementById('modalSeasonSelect').value = currentSeason;
        document.getElementById('teamModal').style.display = 'flex';
        updateModalContent();
    }

    function updateModalContent() {
        const selectedTeam = document.getElementById('modalTeamSelect').value;
        const selectedSeason = document.getElementById('modalSeasonSelect').value;
        const modalSeasonGames = rawData.filter(r => r.Season_Year == selectedSeason);
        const seasonStats = calculateStats(modalSeasonGames);
        const teamData = seasonStats.find(t => t.name === selectedTeam);

        if (!teamData) { return; }

        document.getElementById('modalLogo').src = `https://a.espncdn.com/i/teamlogos/nba/500/scoreboard/${(URL_MAP[selectedTeam]||selectedTeam).toLowerCase()}.png`;
        document.getElementById('valOff').textContent = teamData.offRtg;
        document.getElementById('valDef').textContent = teamData.defRtg;
        document.getElementById('valNet').textContent = (teamData.netRtg > 0 ? '+':'') + teamData.netRtg;
        document.getElementById('valPace').textContent = teamData.pace;

        const homePct = Math.round(teamData._homeWinRate * 100);
        const awayPct = Math.round(teamData._awayWinRate * 100);

        let homeW=0, homeG=0, awayW=0, awayG=0;
        modalSeasonGames.forEach(g => {
            if (g.Team_Abbr === selectedTeam) {
                homeG++;
                if (g.pts > g.opp_pts) homeW++;
            }
            else if (g.Opp_Abbr === selectedTeam) {
                awayG++;
                if (g.opp_pts > g.pts) awayW++; 
            }
        });

        document.getElementById('homeWinVal').textContent = `${homePct}% (${homeW}-${homeG-homeW})`;
        document.getElementById('homeBar').style.width = homePct + "%";
        document.getElementById('awayWinVal').textContent = `${awayPct}% (${awayW}-${awayG-awayW})`;
        document.getElementById('awayBar').style.width = awayPct + "%";

        renderRadarChart(teamData, seasonStats);
    }

    function closeModal() {
        document.getElementById('teamModal').style.display = 'none';
    }

    function renderRadarChart(teamData, allStats) {
        const ctx = document.getElementById('radarChart').getContext('2d');
        if (radarChartInstance) radarChartInstance.destroy();

        const validStats = allStats.filter(t => !isNaN(t._offRtg) && !isNaN(t._defRtg));
        
        const maxOff = Math.max(...validStats.map(t => t._offRtg)) || 120;
        const minOff = Math.min(...validStats.map(t => t._offRtg)) || 100;
        const maxDef = Math.max(...validStats.map(t => t._defRtg)) || 120; 
        const minDef = Math.min(...validStats.map(t => t._defRtg)) || 100; 
        const maxWin = Math.max(...validStats.map(t => t._winRate)) || 1;
        const minWin = Math.min(...validStats.map(t => t._winRate)) || 0;
        const maxNet = Math.max(...validStats.map(t => t._netRtg)) || 15; 
        const minNet = Math.min(...validStats.map(t => t._netRtg)) || -15;
        const maxPace = Math.max(...validStats.map(t => t._pace)) || 105; 
        const minPace = Math.min(...validStats.map(t => t._pace)) || 90;

        const norm = (val, min, max) => {
            if (max === min) return 50;
            let res = (val - min) / (max - min) * 100;
            return Math.max(0, Math.min(100, res)); 
        };
        const normRev = (val, min, max) => {
            if (max === min) return 50;
            let res = (max - val) / (max - min) * 100;
            return Math.max(0, Math.min(100, res));
        };

        const scoreOff = norm(teamData._offRtg, minOff, maxOff);
        const scoreDef = normRev(teamData._defRtg, minDef, maxDef);
        const scoreWin = norm(teamData._winRate, minWin, maxWin);
        const scoreNet = norm(teamData._netRtg, minNet, maxNet); 
        const scorePace = norm(teamData._pace, minPace, maxPace);

        radarChartInstance = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['é€²æ”»', 'é˜²å®ˆ', 'å‹ç‡', 'æ·¨å‹åˆ†', 'ç¯€å¥'],
                datasets: [
                    {
                        label: teamData.name,
                        data: [scoreOff, scoreDef, scoreWin, scoreNet, scorePace],
                        backgroundColor: 'rgba(59, 130, 246, 0.5)',
                        borderColor: '#3b82f6',
                        pointBackgroundColor: '#fff',
                        zIndex: 2
                    },
                    {
                        label: 'League Avg',
                        data: [50, 50, 50, 50, 50],
                        borderColor: '#666',
                        borderDash: [5, 5],
                        borderWidth: 1,
                        pointRadius: 0,
                        backgroundColor: 'transparent',
                        zIndex: 1
                    }
                ]
            },
            options: {
                maintainAspectRatio: false,
                scales: {
                    r: {
                        angleLines: { color: '#777' },
                        grid: { color: '#777' },
                        pointLabels: { color: '#ccc', font: { size: 12 } },
                        suggestedMin: 0,
                        suggestedMax: 100,
                        ticks: { display: false }
                    }
                },
                plugins: { legend: { display: false } }
            }
        });
    }

    document.getElementById('teamModal').addEventListener('click', (e) => {
        if(e.target.id === 'teamModal') closeModal();
    });

    document.getElementById('seasonFilter').addEventListener('change', updateDashboard);
    document.getElementById('confFilter').addEventListener('change', updateDashboard);
    document.getElementById('divFilter').addEventListener('change', updateDashboard);
    document.getElementById('metricFilter').addEventListener('change', updateDashboard);
    document.getElementById('chartMode').addEventListener('change', updateDashboard);

});
</script>

</body>
</html>
